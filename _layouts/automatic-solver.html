<!DOCTYPE html>
<html lang="ja">
  <head>
    {% include head.html %}
  </head>
  <body>
    <header class="site-header" role="banner">
      <div class="wrapper">
        <a class="site-title" rel="author" href="{{ '/' | relative_url }}">{{ site.title }}</a>
        <nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484
                         l0,0C0,0.665,0.665,0,1.484,0h15.032C17.335,0,18,0.665,18,1.484L18,1.484z
                         M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0
                         c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z
                         M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
                         c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>

          <div class="trigger">
            {% for page in site.pages %}
              {% if page.title %}
                <a class="page-link" href="{{ page.url | relative_url }}">{{ page.title }}</a>
              {% endif %}
            {% endfor %}
          </div>
        </nav>
      </div>
    </header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <h1>1次方程式回答システム</h1>
        <input type="text" id="equationInput" placeholder="例: (3/4)x = - (1/6)">
        <div class="output" id="latexOutput"></div>
        <div class="output" id="solutionOutput"></div>
        <script>
            function clean(term) {
            return term.trim().replace(/\s+/g, '');
            }

            function parseTerm(term) {
            term = clean(term);
            let sign = 1;
            if (term.startsWith('-')) {
                sign = -1;
                term = term.slice(1);
            } else if (term.startsWith('+')) {
                term = term.slice(1);
            }

            // x付き項
            if (term.includes('x')) {
                let m = term.match(/^\(?(\d+)\/(\d+)\)?x$/); // (2/3)x or 2/3x
                if (m) {
                const num = m[1], den = m[2];
                return { x: new Decimal(sign).times(new Decimal(num).div(den)), c: new Decimal(0) };
                }

                m = term.match(/^(\d+)x$/); // 2x
                if (m) return { x: new Decimal(sign).times(m[1]), c: new Decimal(0) };

                m = term.match(/^x\/(\d+)$/); // x/3
                if (m) return { x: new Decimal(sign).div(m[1]), c: new Decimal(0) };

                if (term === 'x') return { x: new Decimal(sign), c: new Decimal(0) };

                return { x: new Decimal(0), c: new Decimal(0) }; // 不明な形式
            }

            // 定数項
            let m = term.match(/^\(?(\d+)\/(\d+)\)?$/); // (1/2)
            if (m) return { x: new Decimal(0), c: new Decimal(sign).times(new Decimal(m[1]).div(m[2])) };

            return { x: new Decimal(0), c: new Decimal(sign).times(new Decimal(term)) };
            }

            function parseSide(side) {
            const tokenRegex = /[+-]?\s*\(?\d+\/\d+\)?x?|[+-]?\s*\d+x?|[+-]?\s*x\/\d+|[+-]?\s*\(?\d+\/\d+\)?|[+-]?\s*\d+/g;
            const rawTerms = side.match(tokenRegex) || [];
            let xSum = new Decimal(0), cSum = new Decimal(0);
            for (const t of rawTerms) {
                const { x, c } = parseTerm(t);
                xSum = xSum.plus(x);
                cSum = cSum.plus(c);
            }
            return { x: xSum, c: cSum };
            }

            function formatDecimal(x) {
            const rounded = x.round();
            const diff = x.minus(rounded).abs();
            if (diff.lessThanOrEqualTo('1e-12')) {
                return x.isNegative() ? `-${rounded.abs().toFixed(0)}` : rounded.toFixed(0);
            }

            for (let denom = 1; denom <= 100; denom++) {
                const numer = x.times(denom);
                if (numer.minus(numer.round()).abs().lessThanOrEqualTo('1e-12')) {
                const n = numer.round();
                const sign = n.isNegative() ? '-' : '';
                return `${sign} \\frac{${n.abs().toFixed(0)}}{${denom}}`;
                }
            }

            return x.toDecimalPlaces(6).toString();
            }

            function solveEquation(rawInput) {
            if (!rawInput.includes('=')) return '式に = が含まれていません。';
            const [left, right] = rawInput.split('=');
            if (!left || !right) return '式の左右が不完全です。';

            const L = parseSide(left);
            const R = parseSide(right);
            const a = L.x.minus(R.x);
            const b = R.c.minus(L.c);

            if (a.isZero()) return b.isZero() ? 'すべてのxが解です。' : '解なし';
            const x = b.div(a);
            return `x = ${formatDecimal(x)}`;
            }

            function formatTerm(term) {
            term = term.trim();
            let operator = '+';
            let body = term;

            const opMatch = term.match(/^([+-])\s*(.*)/);
            if (opMatch) {
                operator = opMatch[1];
                body = opMatch[2];
            }

            let m = body.match(/\(?(\d+)\/(\d+)\)?([a-zA-Z])/);
            if (m) return `${operator} \\frac{${m[1]}}{${m[2]}}${m[3]}`;

            m = body.match(/\(?([a-zA-Z])\/(\d+)\)?$/);
            if (m) return `${operator} \\frac{${m[1]}}{${m[2]}}`;

            m = body.match(/\(?(\d+[a-zA-Z])\/(\d+)\)?$/);
            if (m) return `${operator} \\frac{${m[1]}}{${m[2]}}`;

            m = body.match(/\(?(\d+)\/(\d+)\)?$/);
            if (m) return `${operator} \\frac{${m[1]}}{${m[2]}}`;

            return `${operator} ${body}`;
            }

            function generateCustomLatex(rawInput) {
            if (!rawInput.includes('=')) return null;
            const [left, right] = rawInput.split('=');

            function tokenize(expr) {
                return expr.replace(/\s+/g, '')
                .replace(/([-+])/g, ' $1')
                .trim()
                .split(' ');
            }

            const leftTokens = tokenize(left);
            const rightTokens = tokenize(right);

            const leftLatex = leftTokens.map(formatTerm).map((t, i) => i === 0 && t.startsWith('+ ') ? t.slice(2) : t).join(' ');
            const rightLatex = rightTokens.map(formatTerm).map((t, i) => i === 0 && t.startsWith('+ ') ? t.slice(2) : t).join(' ');

            return `${leftLatex} = ${rightLatex}`;
            }

            document.getElementById("equationInput").addEventListener("input", function () {
            const raw = this.value;
            const latex = generateCustomLatex(raw);
            const solution = solveEquation(raw);
            const outputDiv = document.getElementById("latexOutput");
            const solutionDiv = document.getElementById("solutionOutput");

            if (latex) {
                outputDiv.textContent = `\\[${latex}\\]`;
                solutionDiv.textContent = `\\[${solution}\\]`;

                requestAnimationFrame(() => {
                MathJax.typesetPromise([outputDiv, solutionDiv])
                    .catch((err) => {
                    outputDiv.textContent = "MathJaxの描画に失敗しました。";
                    console.error("MathJax error:", err);
                    });
                });
            } else {
                outputDiv.textContent = "式の解析に失敗しました。形式を確認してください。";
                solutionDiv.textContent = "";
            }
            });
        </script>
      </div>
    </main>

    <footer class="site-footer h-card">
      <data class="u-url" href="{{ '/' | relative_url }}"></data>
      <div class="wrapper">
        <h2 class="footer-heading">{{ site.title }}</h2>
        <div class="footer-col-wrapper">
          <div class="footer-col footer-col-1">
            <ul class="contact-list">
              <li class="p-name">{{ site.title }}</li>
            </ul>
          </div>
          <div class="footer-col footer-col-2">
            <ul class="social-media-list"></ul>
          </div>
          <div class="footer-col footer-col-3">
            <p></p>
          </div>
        </div>
      </div>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          twemoji.parse(document.body, {
            folder: "svg",
            ext: ".svg"
          });
        });
      </script>
    </footer>
  </body>
</html>